// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

//~~~~~~~~~ Auth ~~~~~~~~~

enum AuthProvider {
  LOCAL
  GOOGLE
  LINKEDIN
}

model User {
  id            String  @id @default(cuid())
  email         String  @unique
  emailVerified Boolean @default(false)
  phone         String? @unique
  phoneVerified Boolean @default(false)
  passwordHash  String?
  role          Role    @default(AGENT)
  status        Status  @default(PENDING)

  googleId       String?      @unique //oAuth Google Id
  profilePicture String? //Profile Picture received from Google
  provider       AuthProvider @default(LOCAL) // Authentication done through Local/Google etc

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  otps  OTP[] //OTPs received for the user
  agent Agent?
}

model OTP {
  id        String   @id @default(cuid())
  code      String
  type      OTPType
  target    String //email or phone the otp was sent to
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  consumed  Boolean  @default(false)
  createdAt DateTime @default(now())
}

enum OTPType {
  EMAIL
  PHONE
}

enum Role {
  AGENT
  ADMIN
}

enum Status {
  ACTIVE
  INACTIVE
  PENDING
}

//~~~~~~~~~ Step 1 ~~~~~~~~~

model Agent {
  id         String   @id @default(cuid())
  userId     String   @unique
  user       User     @relation(fields: [userId], references: [id], onDelete: SetNull)
  firstName  String
  middleName String?
  lastName   String?
  dob        DateTime

  //Bank Details (Essential for NEFT)
  bankAccountNumber String?
  bankIFSC          String?
  accountHolderName String?
  panNumber         String? // Required for tax compliance in India

  //Shift & Availability
  preferredShift WorkShift @default(FLEXIBLE) // Agent's preferred shift timing
  hoursPerDay    Int       @default(8) // Maximum hours agent can work per day

  qualifications  Qualification[]
  profilePhotoUrl String? // URL to photo in cloud storage

  hasExperience Boolean      @default(false)
  experiences   Experience[]

  isEmployed Boolean     @default(false)
  employment Employment?

  skills    String[]
  languages String[]

  kycStatus    KycStatus     @default(PENDING)
  kycDocuments KYCDocument[] //KYC Information of an agent

  //languageTests  LanguageProficiencyTest[] -> Review with Piyush

  //agreements     Agreement[]  -> Review with Piyush

  reviews        Review[] //Reviews related to the agent (platform reviews, performance reviews, etc.)
  GigApplication GigApplication[]
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  Dispute        Dispute[]
}

enum WorkShift {
  MORNING_9_5 // 09:00 - 17:00 (9 AM - 5 PM)
  AFTERNOON_1_9 // 13:00 - 21:00 (1 PM - 9 PM)
  EVENING_5_1 // 17:00 - 01:00 (5 PM - 1 AM next day)
  NIGHT_1_9 // 01:00 - 09:00 (1 AM - 9 AM next day)
  FLEXIBLE // Any time (agent decides)
  CUSTOM // Custom hours (to be specified separately)
}

model Qualification {
  id        String            @id @default(cuid())
  agentId   String
  agent     Agent             @relation(fields: [agentId], references: [id], onDelete: Cascade)
  type      QualificationType
  field     String?
  startYear Int?
  endYear   Int?
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt
}

enum QualificationType {
  HIGH_SCHOOL
  DIPLOMA
  BACHELORS
  MASTERS
  PHD
  CERTIFICATION
}

model Experience {
  id      String @id @default(cuid())
  agentId String
  agent   Agent  @relation(fields: [agentId], references: [id], onDelete: Cascade)

  experienceMin Int //Lower value of a range eg. 5 in (5-10) experience
  experienceMax Int //Higher value of a range eg. 10 in (5-10) experience
  jobTitle      String?
  industry      String?
  vertical      String?
  companyName   String?

  startDate DateTime
  endDate   DateTime

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Employment {
  id      String @id @default(cuid())
  agentId String @unique
  agent   Agent  @relation(fields: [agentId], references: [id], onDelete: Cascade)

  jobTitle    String?
  industry    String?
  vertical    String?
  companyName String?

  startDate DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model KYCDocument {
  id      String @id @default(cuid())
  agentId String
  agent   Agent  @relation(fields: [agentId], references: [id], onDelete: Cascade)

  documentType   String // "AADHAR", "PAN"
  documentNumber String // AADHAR/PAN Number
  holderName     String? // Name mentioned in Aadhar/Pan

  // File storage
  documentUrl   String? // URL to encrypted document image
  frontImageUrl String? // URL to front image of document 
  backImageUrl  String? // URL to back image of document

  // Verification
  verificationStatus KycStatus @default(PENDING) // pending, verified, rejected
  verifiedAt         DateTime?

  // Metadata for audit
  uploadedAt DateTime @default(now())
  verifiedBy String? // Admin/API that verifies

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum KycStatus {
  PENDING
  APPROVED
  REJECTED
}

enum KycType {
  AADHAR
  PAN
}

//To be Reviewed with Piyush
// Model LanguageProficiencyTest
// Model Agreement 

//~~~~~~~~~ Step 2 ~~~~~~~~~

model Client {
  id String @id @default(cuid())

  // Basic Info
  name  String //Company/Client Name 
  email String @unique //Company/Client Email

  // Company Info
  companyName String
  logo        String?
  website     String?
  phone       String?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  reviews  Review[] //Reviews related to the client
  disputes Dispute[] //Disputes related to the client

  // Relationships
  projects Project[]
}

model Project {
  id String @id @default(cuid())

  // Basic Info
  title       String // "Customer Support Team - Q4 2024"
  description String // Detailed project requirements
  department  String? // "Customer Support", "Sales", "Technical Support"

  // Resource Requirements
  totalHoursNeeded Int // Total hours needed across all opportunities (e.g., 500 hours)
  agentsNeeded     Int // Total number of agents needed (e.g., 10 agents)
  skillsRequired   String[] // Required skills: ["Communication", "CRM", "Problem Solving"]

  // Budget & Timeline
  totalBudget     Decimal  @db.Decimal(10, 2) // Total budget for entire project
  currency        String   @default("INR")
  projectDeadline DateTime // Final completion date


  // Status
  status ProjectStatus @default(PLANNING)

  // Progress Tracking
  hoursCompleted Int @default(0) // Track progress
  agentsHired    Int @default(0) // How many agents hired so far

  // Client Info
  clientId String
  client   Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  // Relationships
  opportunities Opportunity[] // Multiple opportunities created from this project

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum ProjectStatus {
  PLANNING // Client defining requirements, no opportunities yet
  ACTIVE // Opportunities created, hiring in progress
  IN_PROGRESS // Work started, agents working
  COMPLETED // All work finished
  ON_HOLD // Temporarily paused
  CANCELLED // Project cancelled
  CLOSED // Finalized (completed or cancelled)
}

//~~~~~~~~~ Step 3 ~~~~~~~~~

model Opportunity {
  id String @id @default(cuid())

  // Basic Info
  title       String //Opportunity Title
  description String //Description about Opportunity
  category    ServiceCategory @default(BPO) //Type of service agent has to offer (BPO/Content/LLM)

  // Work Details
  processType ProcessType //How work happens/kind of work to be done

  //Time & Duration  
  deadline     DateTime //Apply before this date 

  //Payment
  payAmount   Decimal     @db.Decimal(10, 2) //Money to be paid for the work
  currency    String      @default("INR") //Currency in which money would be paid
  paymentType PaymentType @default(FIXED) //Payment Type like Hourly/Fixed etc

  //Status & Metadata
  status     OpportunityStatus @default(OPEN) //Lifecycle of Opportunity(IN_PROGRESS, COMPLETED, CANCELLED)
  visibility VisibilityLevel   @default(PUBLIC) // Opportunity visible to : (PUBLIC, PRIVATE etc)


  //Project that this opportunity is connected to
  projectId String // FK to brand
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)


  //Skills/Qualifications/Scores Required(To be given by client/admin)

  minimumSkills String[]
  requiredLanguages String[]
  minimumQualifications Json?
  minimumL1Score LanguageProficiency @default(A1)
  preferredExperience Json?

  //Relationships
  applications GigApplication[]
  clientScheduleSlots ClientScheduleSlot[]

  createdAt  DateTime          @default(now())
  updatedAt  DateTime          @updatedAt
}

enum ServiceCategory {
  BPO
  CONTENT
  TECH
}

enum ProcessType {
  INBOUND_CALL      // Voice support
  CHAT_SUPPORT      // Live chat / text
  DATA_ANNOTATION   // Labeling / tagging
  PROMPT_ENGINEERING // LLM prompt & refinement
  TECH_SUPPORT      // General technical help
  QA_TESTING        // Quality / testing tasks
  DOCUMENTATION     // Writing / knowledge base
}

enum DurationType {
  HOURS
  DAYS
  WEEKS
  MONTHS
}

enum OpportunityStatus {
  OPEN // Available, no issues
  IN_PROGRESS // Someone working on it
  ON_HOLD // Paused due to issues
  CANCELLED // Cancelled by client or agent
  COMPLETED // Finished successfully
  CLOSED // Ended (completed or cancelled)
}

enum LanguageProficiency {
  A1
  A2
  B1
  B2
  C1
  C2
}

enum PaymentType {
  FIXED  //Fixed Pay for the work
  HOURLY //Hourly Pay for the work
  MILESTONE_BASIS //Pay for a particular milestone in opportunity
}

enum ApplicationStatus {
  PENDING
  ACCEPTED
  REJECTED
}

enum VisibilityLevel {
  PUBLIC
  PRIVATE
  DRAFT
}

model GigApplication {
  id String @id @default(cuid())

  agentId String //Agent Applying for Opportunity
  agent   Agent  @relation(fields: [agentId], references: [id], onDelete: SetNull)

  opportunityId String //Opportunity agent applied for
  opportunity   Opportunity @relation(fields: [opportunityId], references: [id], onDelete: SetNull)

  // Application Status
  status ApplicationStatus @default(PENDING) // PENDING, ACCEPTED, REJECTED

  //Test Details
  testPassed Boolean @default(false)

  //Relations
  selectedGig SelectedGig?
  dispute     Dispute[]

  // Timestamps
  appliedAt   DateTime     @default(now())
  hireDateAt  DateTime? //Date & Time at which the agent is succesfully accepted for the gig
  
}

model SelectedGig {
  id String @id @default(cuid())

  // Foreign Keys
  gigApplicationId String         @unique //Application which the agent applied for
  gigApplication   GigApplication @relation(fields: [gigApplicationId], references: [id], onDelete: Cascade)

  // Status
  status GigStatus @default(OPEN) // IN_PROGRESS/ON_HOLD/COMPLETED

  // BYOD/CCaaS Setup(Yet to be filled)

  // Relationships
  activityLogs   ActivityLog[] //Activity Logs happened during the gig 
  submittedWorks SubmittedWork[] //Works/Deliverables of particular gig
  reviews        Review[]
  disputes       Dispute[] //Disputes related to any gig work
  AgentWorkSlot AgentWorkSlot?

  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  
}

enum GigStatus {
  OPEN
  IN_PROGRESS
  COMPLETED
  CANCELLED
  ON_HOLD
  CLOSED //Either completed or cancelled and hence closed
}

model ActivityLog {
  id String @id @default(cuid())

  selectedGigId String
  selectedGig   SelectedGig @relation(fields: [selectedGigId], references: [id], onDelete: Cascade)

  // Activity Details
  type        ActivityType //Type of Activity
  description String?

  // When it happened
  startTime DateTime  @default(now())
  endTime   DateTime? // Null if still ongoing (e.g., active session)

  // For Tickets raised
  ticketCount Int? // Number of tickets handled in this period

  createdAt DateTime @default(now())
}

enum ActivityType {
  LOGIN
  LOGOUT
  BREAK
  TICKET_RAISED
}

model SubmittedWork {
  id String @id @default(cuid())

  selectedGigId String
  selectedGig   SelectedGig @relation(fields: [selectedGigId], references: [id], onDelete: Cascade)

  // Work Details
  title       String
  description String?

  // Deliverables
  deliverables String[] // Array of file URLs or descriptions
  // Submission & Status
  status       SubmissionStatus @default(DRAFT) // Lifecycle: DRAFT → PENDING → UNDER_REVIEW → APPROVED/REJECTED/REWORK_NEEDED → COMPLETED
  submittedAt  DateTime? // When work was actually submitted (null if still DRAFT)

  // Review/Approval Details (consolidated here)
  reviewedBy      String? // Admin/Client ID who reviewed
  reviewedAt      DateTime? // When it was reviewed
  rejectionReason String? // Why it was rejected (if status = REJECTED)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  review   Review[] // Optional detailed reviews of this work
  disputes Dispute[] // Optional dispute related to this work
  Payment  Payment[]
}

enum SubmissionStatus {
  DRAFT // Work saved but not yet submitted
  PENDING // Submitted and awaiting review
  UNDER_REVIEW // Currently being reviewed by client/admin
  APPROVED // Work approved and accepted
  REJECTED // Work rejected, no rework
  REWORK_NEEDED // Work needs changes/improvements
  REWORK_SUBMITTED // Reworked version submitted, awaiting re-review
  COMPLETED // Final state - approved and processed
  CANCELLED // Submission cancelled by agent or admin
}

//~~~~~~~~~ Step 4 ~~~~~~~~~

// Time Slots of Weekly Schedule defined by company
model ClientScheduleSlot {
  id String @id @default(cuid())

  opportunityId String
  opportunity   Opportunity @relation(fields: [opportunityId], references: [id], onDelete: Cascade)

  // TimeSlot & Day of week
  timeSlot  TimeSlot // SLOT_09_10, SLOT_14_15, etc.
  dayOfWeek DayOfWeek // MONDAY, TUESDAY, etc.

  //ACTUAL SCHEDULING (calculated from timeSlot + date)
  startDateTime DateTime // 2025-11-13 09:00:00
  endDateTime   DateTime // 2025-11-13 10:00:00

  // How many agents needed for this slot
  agentsRequired Int @default(1)
  agentsFilled   Int @default(0) // How many agents selected this slot

  // Status
  status SlotStatus @default(OPEN) // OPEN, FULL, CLOSED

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  AgentWorkSlot AgentWorkSlot[] // Agents who selected this slot
}

// Agent's Selected Time Slots
model AgentWorkSlot {
  id String @id @default(cuid())

  // SCHEDULE SLOT (the fixed slot they chose)
  clientScheduleSlotId String
  clientScheduleSlot   ClientScheduleSlot @relation(fields: [clientScheduleSlotId], references: [id], onDelete: Cascade)

  //Gig Information for which the agent has time slot for
  selectedGigId String      @unique
  selectedGig   SelectedGig @relation(fields: [selectedGigId], references: [id], onDelete: Cascade)

  // STATUS
  status AgentSlotStatus @default(CONFIRMED)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum SlotStatus {
  OPEN // Available for selection
  FULL // All positions filled
  CLOSED // No longer available
}

enum TimeSlot {
  SLOT_00_01 // 12:00 AM - 01:00 AM
  SLOT_01_02 // 01:00 AM - 02:00 AM
  SLOT_02_03 // 02:00 AM - 03:00 AM
  SLOT_03_04 // 03:00 AM - 04:00 AM
  SLOT_04_05 // 04:00 AM - 05:00 AM
  SLOT_05_06 // 05:00 AM - 06:00 AM
  SLOT_06_07 // 06:00 AM - 07:00 AM
  SLOT_07_08 // 07:00 AM - 08:00 AM
  SLOT_08_09 // 08:00 AM - 09:00 AM
  SLOT_09_10 // 09:00 AM - 10:00 AM
  SLOT_10_11 // 10:00 AM - 11:00 AM
  SLOT_11_12 // 11:00 AM - 12:00 PM
  SLOT_12_13 // 12:00 PM - 01:00 PM
  SLOT_13_14 // 01:00 PM - 02:00 PM
  SLOT_14_15 // 02:00 PM - 03:00 PM
  SLOT_15_16 // 03:00 PM - 04:00 PM
  SLOT_16_17 // 04:00 PM - 05:00 PM
  SLOT_17_18 // 05:00 PM - 06:00 PM
  SLOT_18_19 // 06:00 PM - 07:00 PM
  SLOT_19_20 // 07:00 PM - 08:00 PM
  SLOT_20_21 // 08:00 PM - 09:00 PM
  SLOT_21_22 // 09:00 PM - 10:00 PM
  SLOT_22_23 // 10:00 PM - 11:00 PM
  SLOT_23_24 // 11:00 PM - 12:00 AM
}

enum DayOfWeek {
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
  SUNDAY
}

enum AgentSlotStatus {
  CONFIRMED // Agent confirmed to work this slot
  IN_PROGRESS // Agent is currently working this slot
  COMPLETED // Agent finished working this slot
  CANCELLED // Agent cancelled this slot selection
  NO_SHOW // Agent didn't show up for the slot
  RESCHEDULED // Slot moved to different time
}

//~~~~~ Review/Feedback and Dispute ~~~~~

model Review {
  id String @id @default(cuid())

  // What is being reviewed (polymorphic approach)
  reviewType ReviewType // Type of review

  // Optional foreign keys (only one should be set based on reviewType)
  submittedWorkId String?        
  submittedWork   SubmittedWork? @relation(fields: [submittedWorkId], references: [id], onDelete: Cascade)

  selectedGigId String?
  selectedGig   SelectedGig? @relation(fields: [selectedGigId], references: [id], onDelete: Cascade)

  agentId String? // For platform reviews or agent performance reviews
  agent   Agent?  @relation(fields: [agentId], references: [id], onDelete: Cascade)

  clientId String? // For client reviews
  client   Client? @relation(fields: [clientId], references: [id], onDelete: Cascade)

  // Who is reviewing
  reviewerId   String? // ID of the person giving the review
  reviewerType ReviewerType  @default(ADMIN) // "AGENT", "CLIENT", "ADMIN", "SYSTEM"

  // Review content
  rating   Int? // 1-5 stars (required)
  category ReviewCategory @default(OVERALL) // What aspect is being reviewed
  comment  String? // Optional feedback text

  // Approval/Moderation
  approved Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum ReviewType {
  SUBMITTED_WORK // Review of a specific submitted work
  GIG // Overall review of a gig experience
  PLATFORM // Review of the platform itself
  AGENT // Client reviewing an agent's performance
  CLIENT // Agent reviewing a client/opportunity
}

enum ReviewCategory {
  OVERALL
  QUALITY
  COMMUNICATION
  TIMELINESS
  USER_EXPERIENCE
  PAYMENT
  SUPPORT
  ASSESSMENT
}
enum ReviewerType {
  AGENT        // An agent reviewing (e.g., peer or client performance)
  CLIENT       // Client providing feedback
  ADMIN        // Platform admin / moderator
  SYSTEM       // Auto-generated/system evaluation
  QA           // Dedicated quality/audit reviewer
  TRAINER      // L&D / onboarding evaluator
}

model Dispute {
  id String @id @default(cuid())

  // What is the dispute about (polymorphic approach)
  disputeType DisputeType // Type of dispute

  // Optional foreign keys (only one should be set based on disputeType)
  selectedGigId String?
  selectedGig   SelectedGig? @relation(fields: [selectedGigId], references: [id], onDelete: Cascade)

  gigApplicationId String?
  gigApplication   GigApplication? @relation(fields: [gigApplicationId], references: [id], onDelete: Cascade)


  submittedWorkId String?
  submittedWork   SubmittedWork? @relation(fields: [submittedWorkId], references: [id], onDelete: Cascade)

  paymentId String?
  payment   Payment? @relation(fields: [paymentId], references: [id], onDelete: Cascade)

  agentId String? // For agent-related disputes
  agent   Agent?  @relation(fields: [agentId], references: [id], onDelete: Cascade)

  clientId String? // For client-related disputes
  client   Client? @relation(fields: [clientId], references: [id], onDelete: Cascade)

  // Who raised the dispute
  raisedByType RaisedByType @default(USER)

  // Dispute Details
  title       String
  description String?

  // Evidence/Attachments
  evidenceUrls String[] // URLs to supporting documents/images

  // Status & Resolution
  status     DisputeStatus @default(OPEN) // Lifecycle of Dispute
  resolution String? // How it was resolved
  resolvedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum RaisedByType {
  AGENT // Agent Registered
  USER // General/Other Users
  ADMIN // Admin of the system
}

enum DisputeType {
  SUBMITTED_WORK // Dispute about work quality/delivery
  PAYMENT // Payment-related dispute
  GIG // General gig-related issue
  PLATFORM // Platform functionality/policy issue
  AGENT_CONDUCT // Agent behavior/conduct issue
  OTHER // Other issues
}

enum DisputeStatus {
  OPEN // Newly created, awaiting review
  UNDER_REVIEW // Being investigated by admin
  RESOLVED // Successfully resolved
  ESCALATED // Escalated to higher authority
}

//~~~~~ Payment ~~~~~

enum PaymentStatus {
  PENDING // Payment created, awaiting transfer
  COMPLETED // Money transferred successfully
  FAILED // Transfer failed
  REFUNDED // Money returned (if needed)
}

enum PaymentMethod {
  NEFT // Most common in India
  UPI // For smaller amounts
  BANK_TRANSFER // Generic
}

model Payment {
  id String @id @default(uuid())

  //Core Payment Info
  amount   Float
  currency String        @default("INR")
  status   PaymentStatus @default(PENDING)
  method   PaymentMethod @default(BANK_TRANSFER)

  //Relations
  submittedWorkId String        
  submittedWork   SubmittedWork @relation(fields: [submittedWorkId], references: [id])

  //NEFT Transfer Details (Essential)
  utrNumber    String?   @unique // alphanumeric code assigned to every electronic financial transaction in India
  transferDate DateTime? // When admin initiated NEFT

  //Basic Deductions
  grossAmount Float? // Total before deductions
  tdsAmount   Float  @default(0) // Tax deducted
  platformFee Float  @default(0) // Commission
  netAmount   Float? // Final amount transferred

  // Basic Tracking
  transactionId String?   @unique // Internal reference
  payoutDate    DateTime? // When money reached agent

  // Relationships
  disputes Dispute[] // Disputes related to this payment

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
